<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏û‡∏£‡∏∞‡πÑ‡∏ï‡∏£‡∏õ‡∏¥‡∏é‡∏Å - Tripitaka PWA</title>
  <!--VERSION:manifest-->
  <link rel="manifest" href="manifest.json?v=VERSION_PLACEHOLDER">
  <!--/VERSION-->
  <meta name="theme-color" content="#f59e0b">
  <meta name="description" content="‡∏û‡∏£‡∏∞‡πÑ‡∏ï‡∏£‡∏õ‡∏¥‡∏é‡∏Å ‡∏™‡∏±‡∏á‡∏Ñ‡∏≤‡∏¢‡∏ô‡∏≤ ‡πÅ‡∏•‡∏∞‡∏û‡∏£‡∏∞‡∏™‡∏π‡∏ï‡∏£ - Tripitaka PWA">
  <meta http-equiv="Cache-Control" content="no-cache">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìø</text></svg>">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Sarabun', 'Noto Sans TH', sans-serif;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 600px; margin: 0 auto; }
    h1 { text-align: center; color: #92400e; margin-bottom: 8px; font-size: 1.8rem; }
    .subtitle { text-align: center; color: #b45309; margin-bottom: 20px; font-size: 0.9rem; }
    .breadcrumb {
      background: white;
      padding: 10px 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 0.85rem;
      color: #666;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .breadcrumb span { color: #d97706; cursor: pointer; }
    .breadcrumb span:hover { text-decoration: underline; }
    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.2s;
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .card-header { display: flex; justify-content: space-between; align-items: center; }
    .card h3 { color: #92400e; font-size: 1.1rem; }
    .card .count {
      background: #f59e0b;
      color: white;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
    }
    .card p { color: #666; font-size: 0.9rem; margin-top: 8px; }
    .icon { margin-right: 8px; }
    .back-btn {
      display: inline-block;
      background: #f59e0b;
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 15px;
      font-size: 0.9rem;
    }
    .back-btn:hover { background: #d97706; }
    .hidden { display: none; }
    .sources-section {
      margin-top: 24px;
      border-top: 1px solid #fde68a;
      padding-top: 16px;
    }
    .sources-title {
      font-size: 0.8rem;
      color: #b45309;
      font-weight: 600;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .source-item {
      background: white;
      border-radius: 8px;
      padding: 10px 14px;
      margin-bottom: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
      display: flex;
      align-items: flex-start;
      gap: 10px;
      text-decoration: none;
      color: inherit;
      cursor: pointer;
    }
    .source-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.12); }
    .source-lang {
      background: #fef3c7;
      color: #92400e;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 2px 6px;
      white-space: nowrap;
      margin-top: 2px;
    }
    .source-body { flex: 1; min-width: 0; }
    .source-body strong { color: #374151; font-size: 0.85rem; display: block; }
    .source-body span { color: #9ca3af; font-size: 0.78rem; display: block; margin-top: 2px; word-break: break-all; }
    .source-desc { color: #6b7280; font-size: 0.8rem; margin-top: 3px; }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h1>üìø ‡∏û‡∏£‡∏∞‡πÑ‡∏ï‡∏£‡∏õ‡∏¥‡∏é‡∏Å</h1>
    <p class="subtitle">‡∏™‡∏±‡∏á‡∏Ñ‡∏≤‡∏¢‡∏ô‡∏≤ ‡πÅ‡∏•‡∏∞‡∏û‡∏£‡∏∞‡∏™‡∏π‡∏ï‡∏£</p>
    
    <div id="breadcrumb" class="breadcrumb hidden">
      <span onclick="goHome()">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span> <span id="breadcrumb-text"></span>
    </div>
    
    <div id="content"></div>
  </div>

  <script>
    let data = {};
    
    async function loadData() {
      try {
        const res = await fetch('data.json');
        data = await res.json();
      } catch (e) {
        console.error('Failed to load data:', e);
      }
    }

    let currentView = 'home';
    let currentCouncilId = null;
    let currentNikaya = null;
    let breadcrumbStack = [];

    function saveState() {
      localStorage.setItem('tripitaka_v3_view', currentView);
      localStorage.setItem('tripitaka_v3_council', currentCouncilId || '');
      localStorage.setItem('tripitaka_v3_nikaya', currentNikaya || '');
      
      if (currentView === 'home') {
        history.replaceState(null, '', window.location.pathname);
      } else if (currentView === 'council' && currentCouncilId) {
        history.replaceState(null, '', '#/council/' + currentCouncilId);
      } else if (currentView === 'council') {
        history.replaceState(null, '', '#/council');
      } else if (currentView === 'pitaka') {
        history.replaceState(null, '', '#/pitaka');
      } else if (currentView === 'nikaya' && currentCouncilId && currentNikaya) {
        history.replaceState(null, '', '#/council/' + currentCouncilId + '/' + encodeURIComponent(currentNikaya));
      }
    }

    function loadState() {
      const hash = window.location.hash;
      if (hash.startsWith('#/council/')) {
        const parts = hash.split('/');
        currentView = 'detail';
        currentCouncilId = parseInt(parts[2]);
        if (parts[3]) {
          currentNikaya = decodeURIComponent(parts[3]);
          currentView = 'nikaya';
        }
        return;
      } else if (hash === '#/council') {
        currentView = 'council';
        currentCouncilId = null;
        return;
      } else if (hash === '#/pitaka') {
        currentView = 'pitaka';
        currentCouncilId = null;
        return;
      }
      
      currentView = localStorage.getItem('tripitaka_v3_view') || 'home';
      currentCouncilId = localStorage.getItem('tripitaka_v3_council') || null;
      currentNikaya = localStorage.getItem('tripitaka_v3_nikaya') || null;
      if (currentCouncilId) currentCouncilId = parseInt(currentCouncilId);
    }

    function render() {
      const content = document.getElementById('content');
      const breadcrumb = document.getElementById('breadcrumb');
      
      if (currentNikaya && currentCouncilId) {
        showNikayaDetail(currentCouncilId, currentNikaya);
        return;
      }
      
      if (currentCouncilId) {
        showCouncilDetail(currentCouncilId);
        return;
      }
      
      if (currentView === 'home') {
        breadcrumb.classList.add('hidden');
        content.innerHTML = renderHome();
      } else if (currentView === 'council') {
        breadcrumb.classList.remove('hidden');
        document.getElementById('breadcrumb-text').innerHTML = ' > ‡∏™‡∏±‡∏á‡∏Ñ‡∏≤‡∏¢‡∏ô‡∏≤';
        content.innerHTML = renderCouncilList();
      } else if (currentView === 'pitaka') {
        breadcrumb.classList.remove('hidden');
        document.getElementById('breadcrumb-text').innerHTML = ' > <span onclick="showCouncil()">‡∏™‡∏±‡∏á‡∏Ñ‡∏≤‡∏¢‡∏ô‡∏≤</span> > ‡∏õ‡∏¥‡∏é‡∏Å';
        content.innerHTML = renderPitakaList();
      } else if (currentView === 'detail') {
        breadcrumb.classList.remove('hidden');
        content.innerHTML = '';
      }
    }

    function renderSources() {
      if (!data.sources || data.sources.length === 0) return '';
      return `
        <div class="sources-section">
          <div class="sources-title">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</div>
          ${data.sources.map(s => `
            <a class="source-item" href="${s.url}" target="_blank" rel="noopener noreferrer">
              <span class="source-lang">${s.lang}</span>
              <div class="source-body">
                <strong>${s.title}</strong>
                <span>${s.url}</span>
                <div class="source-desc">${s.desc}</div>
              </div>
            </a>
          `).join('')}
        </div>
      `;
    }

    function renderHome() {
      return `
        <div class="card" onclick="showCouncil()">
          <div class="card-header">
            <h3>üìú ‡∏™‡∏±‡∏á‡∏Ñ‡∏≤‡∏¢‡∏ô‡∏≤ ${data.councils ? data.councils.length : 9} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</h3>
            <span class="count">${data.councils ? data.councils.length : 9}</span>
          </div>
          <p>‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏û‡∏£‡∏∞‡πÑ‡∏ï‡∏£‡∏õ‡∏¥‡∏é‡∏Å ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà ‡∏û.‡∏®. 1 ‡∏ñ‡∏∂‡∏á ‡∏û.‡∏®. 2331 (‡∏ô‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏¢‡πÄ‡∏ñ‡∏£‡∏ß‡∏≤‡∏ó‡πÑ‡∏ó‡∏¢)</p>
        </div>
        <div class="card" onclick="showPitaka()">
          <div class="card-header">
            <h3>üèõÔ∏è ‡∏û‡∏£‡∏∞‡πÑ‡∏ï‡∏£‡∏õ‡∏¥‡∏é‡∏Å 3 ‡∏õ‡∏¥‡∏é‡∏Å</h3>
            <span class="count">3</span>
          </div>
          <p>‡∏ß‡∏¥‡∏ô‡∏±‡∏¢ ‡∏™‡∏∏‡∏ï‡∏ï‡∏±‡∏ô‡∏ï‡πå ‡πÅ‡∏•‡∏∞‡∏≠‡∏†‡∏¥‡∏ò‡∏£‡∏£‡∏°</p>
        </div>
        ${renderSources()}
      `;
    }

    function renderCouncilList() {
      return data.councils.map(c => `
        <div class="card" onclick="showCouncilDetail(${c.id})">
          <div class="card-header">
            <h3>${c.id}. ${c.name}</h3>
            <span class="count">${c.yearShort || c.year}</span>
          </div>
          <p>üìç ${c.location}</p>
          <p>üë§ ‡∏õ‡∏£‡∏∞‡∏ò‡∏≤‡∏ô: ${c.president || c.participants}</p>
          <p>üïê ${c.duration || ''} | ${c.participants}</p>
          ${c.patron && c.patron !== '‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏≤‡∏Å‡∏è' ? `<p>üëë ‡∏≠‡∏∏‡∏õ‡∏ñ‡∏±‡∏°‡∏†‡πå: ${c.patron}</p>` : ''}
          ${c.cause ? `<p style="font-size:0.8rem;color:#888;margin-top:4px;">‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏: ${c.cause}</p>` : ''}
          ${c.nikayas ? `<p class="count" style="display:inline-block;margin-top:8px;">‡∏™‡∏∏‡∏ï‡∏ï‡∏±‡∏ô‡∏ï‡πå 5 ‡∏ô‡∏¥‡∏Å‡∏≤‡∏¢</p>` : ''}
          ${c.abhidharma ? `<p class="count" style="display:inline-block;margin-top:8px;margin-left:8px;">‡∏≠‡∏†‡∏¥‡∏ò‡∏£‡∏£‡∏° 7 ‡∏Ñ‡∏±‡∏°‡∏†‡∏µ‡∏£‡πå</p>` : ''}
          ${c.vinaya ? `<p class="count" style="display:inline-block;margin-top:8px;margin-left:8px;">‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡∏õ‡∏¥‡∏é‡∏Å</p>` : ''}
        </div>
      `).join('');
    }

    function renderPitakaList() {
      return data.pitakas.map(p => `
        <div class="card" onclick="alert('‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ${p.name}')">
          <div class="card-header">
            <h3>${p.icon} ${p.name}</h3>
          </div>
          <p>${p.desc}</p>
        </div>
      `).join('');
    }

    function showCouncil() {
      currentView = 'council';
      currentCouncilId = null;
      saveState();
      render();
    }

    function showPitaka() {
      currentView = 'pitaka';
      saveState();
      render();
    }

    function showCouncilDetail(id) {
      currentCouncilId = id;
      currentNikaya = null;
      currentView = 'detail';
      const council = data.councils.find(c => c.id === id);
      const breadcrumb = document.getElementById('breadcrumb');
      breadcrumb.classList.remove('hidden');
      document.getElementById('breadcrumb-text').innerHTML = ' > <span onclick="showCouncil()">‡∏™‡∏±‡∏á‡∏Ñ‡∏≤‡∏¢‡∏ô‡∏≤</span> > ' + council.name;
      saveState();
      
      let html = `
        <div class="back-btn" onclick="showCouncil()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</div>
        <div class="card">
          <h2>${council.name}</h2>
          <p><strong>‡∏õ‡∏µ:</strong> ${council.year}</p>
          <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong> ${council.location}</p>
          <p><strong>‡∏õ‡∏£‡∏∞‡∏ò‡∏≤‡∏ô:</strong> ${council.president || '-'}</p>
          <p><strong>‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°:</strong> ${council.participants}</p>
          <p><strong>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${council.duration || '-'}</p>
          <p><strong>‡∏ú‡∏π‡πâ‡∏≠‡∏∏‡∏õ‡∏ñ‡∏±‡∏°‡∏†‡πå:</strong> ${council.patron || '-'}</p>
          ${council.cause ? `<p><strong>‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${council.cause}</p>` : ''}
          ${council.description ? `<p style="margin-top:8px;color:#555;">${council.description}</p>` : ''}
        </div>
      `;
      
      if (council.nikayas) {
        html += `
          <h3 style="color:#92400e;margin:20px 0 10px;">üìñ ‡∏™‡∏∏‡∏ï‡∏ï‡∏±‡∏ô‡∏ï‡∏õ‡∏¥‡∏é‡∏Å - ‡∏ô‡∏¥‡∏Å‡∏≤‡∏¢</h3>
          ${council.nikayas.map((n, idx) => `
            <div class="card" onclick="showNikayaDetail(${council.id}, '${n.name}')">
              <div class="card-header">
                <h3>${n.name}</h3>
                <span class="count">${n.count} ‡∏™‡∏π‡∏ï‡∏£</span>
              </div>
              <p>${n.thai || ''}</p>
              <p>${n.desc}</p>
            </div>
          `).join('')}
        `;
      }
      
      if (council.abhidharma) {
        html += `
          <h3 style="color:#92400e;margin:20px 0 10px;">üß† ‡∏≠‡∏†‡∏¥‡∏ò‡∏£‡∏£‡∏°‡∏õ‡∏¥‡∏é‡∏Å</h3>
          ${council.abhidharma.map(a => `
            <div class="card">
              <h3>${a.name}</h3>
              <p>${a.desc}</p>
            </div>
          `).join('')}
        `;
      }
      
      if (council.vinaya) {
        html += `
          <h3 style="color:#92400e;margin:20px 0 10px;">‚öñÔ∏è ‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡∏õ‡∏¥‡∏é‡∏Å</h3>
          ${council.vinaya.map(v => `
            <div class="card">
              <div class="card-header">
                <h3>${v.name}</h3>
                ${v.count ? `<span class="count">${v.count} ‡∏Ç‡πâ‡∏≠</span>` : ''}
              </div>
              <p>${v.desc}</p>
            </div>
          `).join('')}
        `;
      }
      
      html += renderSources();
      document.getElementById('content').innerHTML = html;
    }

    function showNikayaDetail(councilId, nikayaName) {
      const council = data.councils.find(c => c.id === councilId);
      const nikaya = council.nikayas.find(n => n.name === nikayaName);
      currentCouncilId = councilId;
      currentNikaya = nikayaName;
      currentView = 'nikaya';
      
      const breadcrumb = document.getElementById('breadcrumb');
      breadcrumb.classList.remove('hidden');
      document.getElementById('breadcrumb-text').innerHTML = 
        ' > <span onclick="showCouncil()">‡∏™‡∏±‡∏á‡∏Ñ‡∏≤‡∏¢‡∏ô‡∏≤</span> > <span onclick="showCouncilDetail(' + councilId + ')">' + council.name + '</span> > ' + nikayaName;
      saveState();
      
      let html = `
        <div class="back-btn" onclick="showCouncilDetail(${councilId})">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</div>
        <div class="card">
          <h2>${nikaya.name}</h2>
          <p>${nikaya.thai || ''}</p>
          <p>${nikaya.desc}</p>
          <p class="count" style="display:inline-block;margin-top:8px;">${nikaya.count} ‡∏™‡∏π‡∏ï‡∏£</p>
        </div>
        <h3 style="color:#92400e;margin:20px 0 10px;">üìú ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ï‡∏£</h3>
      `;
      
      if (nikaya.sutras && nikaya.sutras.length > 0) {
        html += nikaya.sutras.map(s => `
          <div class="card">
            <h3>${s.name}</h3>
            <p>${s.desc}</p>
          </div>
        `).join('');
      } else {
        html += '<div class="card"><p>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...</p></div>';
      }
      
      document.getElementById('content').innerHTML = html;
    }

    function goHome() {
      currentView = 'home';
      currentCouncilId = null;
      saveState();
      render();
    }

    async function init() {
      loadState();
      render();
    }

    loadData().then(init);

    // Handle browser back/forward and hash changes
    window.addEventListener('hashchange', () => {
      loadState();
      render();
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js?v=VERSION_PLACEHOLDER');
    }
  </script>
</body>
</html>
